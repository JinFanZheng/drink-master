name: Issue Automation

on:
  issues:
    types: [opened, labeled, unlabeled, closed, reopened]
  issue_comment:
    types: [created]

jobs:
  issue-triage:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Auto-label new issues
        if: github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸ·ï¸  Auto-labeling new issue...');
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const title = context.payload.issue.title.toLowerCase();
            const body = (context.payload.issue.body || '').toLowerCase();
            
            const labels = [];
            
            // Auto-assign priority based on keywords
            if (title.includes('urgent') || title.includes('critical') || body.includes('urgent')) {
              labels.push('priority-high');
            } else if (title.includes('important') || body.includes('important')) {
              labels.push('priority-medium');
            } else {
              labels.push('priority-low');
            }
            
            // Auto-assign type based on keywords
            if (title.includes('bug') || title.includes('error') || title.includes('fix')) {
              labels.push('bug');
            } else if (title.includes('feature') || title.includes('enhancement')) {
              labels.push('enhancement');
            } else if (title.includes('doc') || title.includes('documentation')) {
              labels.push('documentation');
            } else if (title.includes('api') || body.includes('api')) {
              labels.push('api');
            } else if (title.includes('backend') || body.includes('backend')) {
              labels.push('backend');
            }
            
            if (labels.length > 0) {
              try {
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number,
                  labels
                });
                console.log(`âœ… Added labels: ${labels.join(', ')}`);
              } catch (error) {
                console.error('âŒ Failed to add labels:', error.message);
              }
            }

      - name: Welcome new contributors
        if: github.event.action == 'opened' && github.event.issue.author_association == 'FIRST_TIME_CONTRIBUTOR'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸ‘‹ Welcoming new contributor...');
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            
            const welcomeMessage = `
            ğŸ‘‹ æ¬¢è¿æ¥åˆ° drink-master é¡¹ç›®ï¼æ„Ÿè°¢æ‚¨æäº¤ç¬¬ä¸€ä¸ª Issueã€‚

            ä¸ºäº†å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°å¤„ç†æ‚¨çš„è¯·æ±‚ï¼Œè¯·ç¡®ä¿ï¼š
            - ğŸ“‹ æä¾›æ¸…æ™°çš„é—®é¢˜æè¿°æˆ–åŠŸèƒ½éœ€æ±‚
            - ğŸ” å¦‚æœæ˜¯ bugï¼Œè¯·æä¾›å¤ç°æ­¥éª¤
            - ğŸ¯ å¦‚æœæ˜¯æ–°åŠŸèƒ½ï¼Œè¯·è¯´æ˜ä½¿ç”¨åœºæ™¯

            æˆ‘ä»¬ä¼šå°½å¿«æŸ¥çœ‹å¹¶å›å¤æ‚¨çš„ Issueã€‚å¦‚æœæ‚¨æƒ³è¦å‚ä¸å¼€å‘ï¼Œå¯ä»¥æŸ¥çœ‹ï¼š
            - ğŸ“š [å¼€å‘æŒ‡å—](docs/AGENT_ONBOARDING.md)
            - ğŸ¤ [åä½œæŒ‡å—](docs/ROLES_COLLABORATION.md)
            `;
            
            try {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: welcomeMessage.trim()
              });
              console.log('âœ… Welcome comment posted');
            } catch (error) {
              console.error('âŒ Failed to post welcome comment:', error.message);
            }
  issue-commands:
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    steps:
      - name: Handle issue commands
        uses: actions/github-script@v7
        with:
          script: |
            const body = (context.payload.comment.body || '').trim();
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const actor = context.actor;
            
            console.log(`Processing command: ${body}`);
            
            // Handle /claim command
            if (/^\/claim\b/.test(body)) {
              console.log('ğŸ¯ Processing /claim command...');
              try {
                // Assign commenter to the issue
                await github.rest.issues.addAssignees({ 
                  owner, 
                  repo, 
                  issue_number, 
                  assignees: [actor] 
                });
                
                // Add in-progress label
                await github.rest.issues.addLabels({ 
                  owner, 
                  repo, 
                  issue_number, 
                  labels: ['in-progress'] 
                });
                
                // Add confirmation comment
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number,
                  body: `âœ… Issue claimed by @${actor}. Status updated to **in-progress**.`
                });
                
                console.log(`âœ… Issue #${issue_number} claimed by ${actor}`);
              } catch (error) {
                console.error('âŒ Failed to process /claim command:', error.message);
                
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number,
                  body: `âŒ Failed to claim issue: ${error.message}`
                });
              }
              return;
            }
            
            // Handle /unclaim command
            if (/^\/unclaim\b/.test(body)) {
              console.log('ğŸ”„ Processing /unclaim command...');
              try {
                // Remove assignee
                await github.rest.issues.removeAssignees({ 
                  owner, 
                  repo, 
                  issue_number, 
                  assignees: [actor] 
                });
                
                // Remove in-progress label
                try {
                  await github.rest.issues.removeLabel({ 
                    owner, 
                    repo, 
                    issue_number, 
                    name: 'in-progress'
                  });
                } catch (e) {
                  // Label might not exist, which is fine
                  console.log('Label "in-progress" not found, skipping removal');
                }
                
                // Add confirmation comment
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number,
                  body: `ğŸ”„ Issue unclaimed by @${actor}. Available for others to claim.`
                });
                
                console.log(`âœ… Issue #${issue_number} unclaimed by ${actor}`);
              } catch (error) {
                console.error('âŒ Failed to process /unclaim command:', error.message);
              }
              return;
            }
            
            // Handle /help command
            if (/^\/help\b/.test(body)) {
              console.log('â“ Processing /help command...');
              const helpMessage = `
              ## ğŸ¤– Available Commands
              
              - \`/claim\` - Claim this issue and mark as in-progress
              - \`/unclaim\` - Unclaim this issue and make it available
              - \`/help\` - Show this help message
              
              ## ğŸ“‹ Development Guidelines
              
              - ğŸ“š Check [Development Guide](docs/AGENT_ONBOARDING.md) for workflow
              - ğŸ¤ Review [Collaboration Guide](docs/ROLES_COLLABORATION.md) for roles
              - âœ… Ensure 80%+ test coverage before submitting PR
              - ğŸ¯ Follow conventional commit format
              `;
              
              try {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number,
                  body: helpMessage.trim()
                });
                console.log('âœ… Help message posted');
              } catch (error) {
                console.error('âŒ Failed to post help message:', error.message);
              }
              return;
            }
            
            console.log('No matching command found');