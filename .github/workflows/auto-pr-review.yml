name: Auto PR Review & Merge

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    branches: [main]
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿è¿›è¡Œé£é™©åˆ†æ

      - name: PR Risk Assessment
        id: risk-assessment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
        run: |
          echo "ğŸ” åˆ†æPRé£é™©ç­‰çº§..."
          
          # è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨
          CHANGED_FILES=$(gh pr diff $PR_NUMBER --name-only)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # è·å–PRæ ‡é¢˜åˆ¤æ–­ç±»å‹
          PR_TITLE=$(gh pr view $PR_NUMBER --json title -q .title)
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          
          # é£é™©ç­‰çº§è¯„ä¼°
          RISK_LEVEL="low"
          RISK_REASONS=""
          
          # æ£€æŸ¥é«˜é£é™©å˜æ›´
          if echo "$CHANGED_FILES" | grep -E "(internal/contracts|migrations/|internal/models|security|auth)"; then
            RISK_LEVEL="high"
            RISK_REASONS="æ£€æµ‹åˆ°é«˜é£é™©æ–‡ä»¶å˜æ›´ï¼ˆå¥‘çº¦/æ•°æ®åº“/å®‰å…¨ï¼‰"
            echo "ğŸš¨ é«˜é£é™©å˜æ›´æ£€æµ‹"
          elif echo "$CHANGED_FILES" | grep -E "(internal/handlers|internal/services)"; then
            RISK_LEVEL="medium"
            RISK_REASONS="æ£€æµ‹åˆ°ä¸šåŠ¡é€»è¾‘å˜æ›´"
            echo "âš ï¸ ä¸­é£é™©å˜æ›´æ£€æµ‹"
          elif echo "$PR_TITLE" | grep -E "^(feat|fix|refactor):"; then
            RISK_LEVEL="medium"
            RISK_REASONS="åŠŸèƒ½/ä¿®å¤/é‡æ„ç±»å‹å˜æ›´"
            echo "âš ï¸ ä¸­é£é™©å˜æ›´æ£€æµ‹"
          elif echo "$PR_TITLE" | grep -E "^(docs|style|test|chore):"; then
            RISK_LEVEL="low"
            RISK_REASONS="ä½é£é™©å˜æ›´ç±»å‹"
            echo "âœ… ä½é£é™©å˜æ›´æ£€æµ‹"
          fi
          
          echo "risk_level=$RISK_LEVEL" >> $GITHUB_OUTPUT
          echo "risk_reasons=$RISK_REASONS" >> $GITHUB_OUTPUT
          echo "é£é™©ç­‰çº§: $RISK_LEVEL - $RISK_REASONS"

      - name: Basic Validation Checks
        id: basic-checks
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
        run: |
          echo "ğŸ” æ‰§è¡ŒåŸºç¡€éªŒè¯æ£€æŸ¥..."
          
          # æ£€æŸ¥å¯åˆå¹¶çŠ¶æ€
          MERGEABLE=$(gh pr view $PR_NUMBER --json mergeable -q .mergeable)
          if [ "$MERGEABLE" != "true" ]; then
            echo "âŒ PRå­˜åœ¨åˆå¹¶å†²çª"
            echo "mergeable=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "âœ… æ— åˆå¹¶å†²çª"
          echo "mergeable=true" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥Issueé“¾æ¥
          ISSUE_LINK=$(gh pr view $PR_NUMBER --json body -q .body | grep -E "(Fixes|Closes) #[0-9]+" || echo "")
          if [ -z "$ISSUE_LINK" ]; then
            echo "âš ï¸ æœªå‘ç°Issueé“¾æ¥"
            echo "has_issue_link=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… å‘ç°Issueé“¾æ¥: $ISSUE_LINK"
            echo "has_issue_link=true" >> $GITHUB_OUTPUT
          fi

      - name: Check CI Status
        if: steps.basic-checks.outputs.mergeable == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
        run: |
          echo "ğŸ” æ£€æŸ¥CIçŠ¶æ€..."
          
          # ç­‰å¾…CIå®Œæˆå¹¶æ£€æŸ¥çŠ¶æ€
          echo "ç­‰å¾…CIå·¥ä½œæµå®Œæˆ..."
          timeout 300s bash -c '
            while true; do
              CI_STATUS=$(gh pr checks $PR_NUMBER --json state,conclusion | jq -r ".[] | select(.name==\"CI\") | .conclusion")
              if [ "$CI_STATUS" = "success" ]; then
                echo "âœ… CIæ£€æŸ¥é€šè¿‡"
                break
              elif [ "$CI_STATUS" = "failure" ] || [ "$CI_STATUS" = "cancelled" ]; then
                echo "âŒ CIæ£€æŸ¥å¤±è´¥: $CI_STATUS"
                exit 1
              else
                echo "â³ CIæ­£åœ¨è¿è¡Œï¼Œç­‰å¾…ä¸­..."
                sleep 10
              fi
            done
          '
          
          echo "âœ… æ‰€æœ‰è´¨é‡æ£€æŸ¥å·²é€šè¿‡"

      - name: Additional Validation for Medium/High Risk
        if: steps.risk-assessment.outputs.risk_level == 'medium' || steps.risk-assessment.outputs.risk_level == 'high'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
        run: |
          echo "ğŸ§ª æ‰§è¡Œé¢å¤–éªŒè¯..."
          
          # å¯¹äºä¸­é«˜é£é™©PRï¼Œè¿›è¡Œé¢å¤–çš„æ£€æŸ¥
          if [ "${{ steps.risk-assessment.outputs.risk_level }}" = "high" ]; then
            echo "ğŸš¨ é«˜é£é™©PRéœ€è¦é¢å¤–å…³æ³¨"
            # æ£€æŸ¥æ˜¯å¦æœ‰breaking changes
            if gh pr view $PR_NUMBER --json body | grep -i -E "(breaking|BREAKING)"; then
              echo "âš ï¸ å‘ç°æ½œåœ¨çš„ç ´åæ€§å˜æ›´"
            fi
          fi
          
          echo "âœ… é¢å¤–éªŒè¯å®Œæˆ"

      - name: GitHub Copilot Code Review (Medium/High Risk)
        if: steps.risk-assessment.outputs.risk_level != 'low'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
        run: |
          echo "ğŸ¤– GitHub Copilotä»£ç å®¡æŸ¥..."
          
          # æ¨¡æ‹ŸCopilotå®¡æŸ¥ï¼ˆå®é™…éƒ¨ç½²æ—¶éœ€è¦é…ç½®GitHub Copilot APIï¼‰
          echo "å¯¹PR #$PR_NUMBER è¿›è¡Œä»£ç è´¨é‡å’Œé€»è¾‘å®¡æŸ¥..."
          
          # æ£€æŸ¥ä»£ç å¤æ‚åº¦
          if golangci-lint run --disable-all --enable=gocyclo; then
            echo "âœ… ä»£ç å¤æ‚åº¦æ£€æŸ¥é€šè¿‡"
          else
            echo "âš ï¸ å‘ç°å¤æ‚åº¦è¾ƒé«˜çš„ä»£ç ï¼Œå»ºè®®ä¼˜åŒ–"
            # æ·»åŠ è¯„è®ºä½†ä¸é˜»å¡åˆå¹¶
            gh pr comment $PR_NUMBER --body "ğŸ¤– **è‡ªåŠ¨ä»£ç å®¡æŸ¥å»ºè®®**\n\nå‘ç°éƒ¨åˆ†ä»£ç å¤æ‚åº¦è¾ƒé«˜ï¼Œå»ºè®®è€ƒè™‘é‡æ„ä»¥æé«˜å¯ç»´æŠ¤æ€§ã€‚"
          fi

      - name: Auto Merge Decision
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
          RISK_LEVEL: ${{ steps.risk-assessment.outputs.risk_level }}
          RISK_REASONS: ${{ steps.risk-assessment.outputs.risk_reasons }}
        run: |
          echo "ğŸ¯ è‡ªåŠ¨åˆå¹¶å†³ç­–..."
          
          case "$RISK_LEVEL" in
            "low")
              echo "âœ… ä½é£é™©PRï¼Œæ‰§è¡Œè‡ªåŠ¨åˆå¹¶"
              gh pr merge $PR_NUMBER --squash --delete-branch
              gh pr comment $PR_NUMBER --body "ğŸ¤– **è‡ªåŠ¨åˆå¹¶å®Œæˆ**\n\n- é£é™©ç­‰çº§: ä½\n- åŸå› : $RISK_REASONS\n- æ‰€æœ‰è´¨é‡æ£€æŸ¥é€šè¿‡\n\nç”±AIä»£ç†è‡ªåŠ¨å¤„ç† âœ¨"
              ;;
            "medium")
              echo "âš ï¸ ä¸­é£é™©PRï¼Œæ¡ä»¶åˆå¹¶"
              if [ "${{ steps.basic-checks.outputs.has_issue_link }}" == "true" ]; then
                gh pr merge $PR_NUMBER --squash --delete-branch
                gh pr comment $PR_NUMBER --body "ğŸ¤– **è‡ªåŠ¨åˆå¹¶å®Œæˆ**\n\n- é£é™©ç­‰çº§: ä¸­\n- åŸå› : $RISK_REASONS\n- æ‰€æœ‰éªŒè¯æ£€æŸ¥é€šè¿‡\n- åŠŸèƒ½æµ‹è¯•æ­£å¸¸\n\nç”±AIä»£ç†å®¡æŸ¥åè‡ªåŠ¨å¤„ç† âœ¨"
              else
                gh pr edit $PR_NUMBER --add-label "needs-issue-link"
                gh pr comment $PR_NUMBER --body "âš ï¸ **éœ€è¦è¡¥å……ä¿¡æ¯**\n\næ­¤PRç¼ºå°‘Issueé“¾æ¥ï¼Œè¯·åœ¨æè¿°ä¸­æ·»åŠ  \`Fixes #<issue-number>\` åé‡æ–°è§¦å‘æ£€æŸ¥ã€‚"
              fi
              ;;
            "high")
              echo "ğŸš¨ é«˜é£é™©PRï¼Œéœ€è¦äººå·¥å®¡æ ¸"
              gh pr edit $PR_NUMBER --add-label "needs-human-review"
              gh pr comment $PR_NUMBER --body "ğŸš¨ **éœ€è¦äººå·¥å®¡æ ¸**\n\n- é£é™©ç­‰çº§: é«˜\n- åŸå› : $RISK_REASONS\n\næ­¤PRåŒ…å«é«˜é£é™©å˜æ›´ï¼Œå·²æ ‡è®°éœ€è¦äººå·¥å®¡æ ¸ã€‚è¯·ç›¸å…³è´Ÿè´£äººå®¡æ ¸åæ‰‹åŠ¨åˆå¹¶ã€‚"
              ;;
          esac

      - name: Cleanup on Failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
        run: |
          echo "âŒ è‡ªåŠ¨å¤„ç†å¤±è´¥ï¼Œæ·»åŠ æ ‡ç­¾å¹¶é€šçŸ¥"
          gh pr edit $PR_NUMBER --add-label "auto-merge-failed"
          gh pr comment $PR_NUMBER --body "âŒ **è‡ªåŠ¨å¤„ç†å¤±è´¥**\n\nè‡ªåŠ¨åˆå¹¶æµç¨‹é‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹CIæ—¥å¿—äº†è§£è¯¦æƒ…ã€‚å¯èƒ½éœ€è¦æ‰‹åŠ¨ä¿®å¤åé‡æ–°è§¦å‘ã€‚"