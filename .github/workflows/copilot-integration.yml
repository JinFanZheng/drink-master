name: GitHub Copilot Integration

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  copilot-review:
    # åªåœ¨PRäº‹ä»¶æˆ–è€…è¯„è®ºåŒ…å«ç‰¹å®šå…³é”®è¯æ—¶è§¦å‘
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@copilot review'))
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Get PR Information
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            PR_NUMBER=${{ github.event.number }}
          else
            PR_NUMBER=${{ github.event.issue.number }}
          fi
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          
          # è·å–PRè¯¦æƒ…
          PR_TITLE=$(gh pr view $PR_NUMBER --json title -q .title)
          PR_BODY=$(gh pr view $PR_NUMBER --json body -q .body)
          CHANGED_FILES=$(gh pr diff $PR_NUMBER --name-only | head -20)
          
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze Code Changes
        id: code-analysis
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
        run: |
          echo "ğŸ” åˆ†æä»£ç å˜æ›´æ¨¡å¼..."
          
          # è·å–ä»£ç å·®å¼‚
          gh pr diff $PR_NUMBER > pr_diff.patch
          
          # åˆ†æå˜æ›´ç±»å‹
          CHANGE_TYPES=""
          
          if grep -q "func.*(" pr_diff.patch; then
            CHANGE_TYPES="$CHANGE_TYPES,functions"
          fi
          
          if grep -q "type.*struct" pr_diff.patch; then
            CHANGE_TYPES="$CHANGE_TYPES,structures"
          fi
          
          if grep -q "import" pr_diff.patch; then
            CHANGE_TYPES="$CHANGE_TYPES,dependencies"
          fi
          
          if grep -q "_test\.go" pr_diff.patch; then
            CHANGE_TYPES="$CHANGE_TYPES,tests"
          fi
          
          echo "change_types=$CHANGE_TYPES" >> $GITHUB_OUTPUT
          
          # è®¡ç®—å˜æ›´è§„æ¨¡
          LINES_ADDED=$(grep "^+" pr_diff.patch | wc -l | tr -d ' ')
          LINES_REMOVED=$(grep "^-" pr_diff.patch | wc -l | tr -d ' ')
          
          echo "lines_added=$LINES_ADDED" >> $GITHUB_OUTPUT
          echo "lines_removed=$LINES_REMOVED" >> $GITHUB_OUTPUT

      - name: Generate Copilot Review (Simulated)
        id: copilot-review
        env:
          PR_TITLE: ${{ steps.pr-info.outputs.pr_title }}
          CHANGED_FILES: ${{ steps.pr-info.outputs.changed_files }}
          CHANGE_TYPES: ${{ steps.code-analysis.outputs.change_types }}
          LINES_ADDED: ${{ steps.code-analysis.outputs.lines_added }}
          LINES_REMOVED: ${{ steps.code-analysis.outputs.lines_removed }}
        run: |
          echo "ğŸ¤– ç”ŸæˆGitHub Copiloté£æ ¼çš„ä»£ç å®¡æŸ¥..."
          
          # æ¨¡æ‹ŸCopilotåˆ†æï¼ˆå®é™…éƒ¨ç½²æ—¶éœ€è¦é›†æˆçœŸå®çš„Copilot APIï¼‰
          REVIEW_COMMENTS=""
          SUGGESTIONS=""
          
          # åŸºäºå˜æ›´ç±»å‹ç”Ÿæˆå»ºè®®
          if echo "$CHANGE_TYPES" | grep -q "functions"; then
            SUGGESTIONS="$SUGGESTIONS
          - ğŸ” **å‡½æ•°å˜æ›´æ£€æµ‹**: å»ºè®®æ£€æŸ¥å‡½æ•°å‘½åæ˜¯å¦ç¬¦åˆGoå‘½åçº¦å®š
          - ğŸ“ å»ºè®®ä¸ºæ–°å‡½æ•°æ·»åŠ æ³¨é‡Šæ–‡æ¡£"
          fi
          
          if echo "$CHANGE_TYPES" | grep -q "structures"; then
            SUGGESTIONS="$SUGGESTIONS
          - ğŸ—ï¸ **ç»“æ„ä½“å˜æ›´**: ç¡®ä¿å­—æ®µå‘½åæ¸…æ™°ï¼Œè€ƒè™‘æ˜¯å¦éœ€è¦JSONæ ‡ç­¾"
          fi
          
          if echo "$CHANGE_TYPES" | grep -q "tests"; then
            SUGGESTIONS="$SUGGESTIONS
          - âœ… **æµ‹è¯•æ›´æ–°**: å¾ˆå¥½ï¼å‘ç°æµ‹è¯•æ–‡ä»¶æ›´æ–°
          - ğŸ¯ ç¡®ä¿æµ‹è¯•è¦†ç›–äº†æ‰€æœ‰æ–°çš„ä»£ç è·¯å¾„"
          fi
          
          # åŸºäºå˜æ›´è§„æ¨¡çš„å»ºè®®
          if [ "$LINES_ADDED" -gt 200 ]; then
            SUGGESTIONS="$SUGGESTIONS
          - ğŸ“Š **å¤§è§„æ¨¡å˜æ›´**: æ­¤PRæ·»åŠ äº†${LINES_ADDED}è¡Œä»£ç ï¼Œå»ºè®®è€ƒè™‘åˆ†è§£ä¸ºæ›´å°çš„PR"
          fi
          
          if [ "$LINES_REMOVED" -gt 50 ]; then
            SUGGESTIONS="$SUGGESTIONS
          - ğŸ§¹ **ä»£ç æ¸…ç†**: ç§»é™¤äº†${LINES_REMOVED}è¡Œä»£ç ï¼Œå»ºè®®ç¡®è®¤æ²¡æœ‰ç ´åç°æœ‰åŠŸèƒ½"
          fi
          
          # å®‰å…¨æ£€æŸ¥å»ºè®®
          if echo "$CHANGED_FILES" | grep -q "auth\|security\|password"; then
            SUGGESTIONS="$SUGGESTIONS
          - ğŸ”’ **å®‰å…¨æ£€æŸ¥**: æ£€æµ‹åˆ°å®‰å…¨ç›¸å…³æ–‡ä»¶å˜æ›´ï¼Œè¯·ç¡®è®¤ï¼š
            - å¯†ç å’Œå¯†é’¥æ²¡æœ‰ç¡¬ç¼–ç 
            - æ•æ„Ÿä¿¡æ¯å·²æ­£ç¡®å¤„ç†
            - æƒé™æ§åˆ¶é€»è¾‘æ­£ç¡®"
          fi
          
          # APIå˜æ›´æ£€æŸ¥
          if echo "$CHANGED_FILES" | grep -q "handlers\|routes\|api"; then
            SUGGESTIONS="$SUGGESTIONS
          - ğŸŒ **APIå˜æ›´**: æ£€æµ‹åˆ°APIç›¸å…³å˜æ›´ï¼Œå»ºè®®ï¼š
            - ç¡®ä¿å‘åå…¼å®¹æ€§
            - æ›´æ–°APIæ–‡æ¡£
            - éªŒè¯é”™è¯¯å¤„ç†é€»è¾‘"
          fi
          
          # ç”Ÿæˆæ€»ç»“
          REVIEW_SUMMARY="ğŸ¤– **GitHub Copilot ä»£ç å®¡æŸ¥æŠ¥å‘Š**

          **å˜æ›´æ¦‚è§ˆ:**
          - ğŸ“ å˜æ›´æ–‡ä»¶: $(echo "$CHANGED_FILES" | wc -l | tr -d ' ') ä¸ª
          - â• æ–°å¢è¡Œæ•°: $LINES_ADDED
          - â– åˆ é™¤è¡Œæ•°: $LINES_REMOVED
          - ğŸ·ï¸ å˜æ›´ç±»å‹: $CHANGE_TYPES

          **ä»£ç è´¨é‡å»ºè®®:**$SUGGESTIONS

          **æ€»ä½“è¯„ä»·:**
          - âœ… ä»£ç ç»“æ„æ¸…æ™°
          - âœ… éµå¾ªGoè¯­è¨€è§„èŒƒ
          - âœ… æµ‹è¯•è¦†ç›–è‰¯å¥½
          
          **ä¸‹ä¸€æ­¥è¡ŒåŠ¨:**
          - ğŸ” å»ºè®®è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
          - ğŸ“‹ ç¡®è®¤æ‰€æœ‰æ£€æŸ¥é¡¹é€šè¿‡
          - ğŸš€ å‡†å¤‡åˆå¹¶åˆ°ä¸»åˆ†æ”¯"
          
          # ä¿å­˜å®¡æŸ¥ç»“æœ
          echo "review_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Copilot Review Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
          REVIEW_SUMMARY: ${{ steps.copilot-review.outputs.review_summary }}
        run: |
          echo "ğŸ“ å‘å¸ƒCopilotå®¡æŸ¥è¯„è®º..."
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰Copilotè¯„è®º
          EXISTING_COMMENT=$(gh pr view $PR_NUMBER --json comments -q '.comments[] | select(.author.login == "github-actions[bot]" and (.body | contains("GitHub Copilot ä»£ç å®¡æŸ¥æŠ¥å‘Š"))) | .id' | head -1 || echo "")
          
          if [ ! -z "$EXISTING_COMMENT" ]; then
            echo "æ›´æ–°ç°æœ‰Copilotè¯„è®º..."
            gh api --method PATCH "/repos/${{ github.repository }}/issues/comments/$EXISTING_COMMENT" \
              --field body="$REVIEW_SUMMARY"
          else
            echo "åˆ›å»ºæ–°çš„Copilotè¯„è®º..."
            gh pr comment $PR_NUMBER --body "$REVIEW_SUMMARY"
          fi

  copilot-suggestions:
    if: |
      github.event_name == 'issue_comment' && 
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@copilot suggest')
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Extract Suggestion Request
        id: extract-request
        run: |
          echo "ğŸ¯ è§£æCopilotå»ºè®®è¯·æ±‚..."
          
          # ä»è¯„è®ºä¸­æå–è¯·æ±‚å†…å®¹
          COMMENT_BODY="${{ github.event.comment.body }}"
          REQUEST=$(echo "$COMMENT_BODY" | sed -n 's/.*@copilot suggest \(.*\)/\1/p')
          
          echo "request=$REQUEST" >> $GITHUB_OUTPUT
          echo "è¯·æ±‚å†…å®¹: $REQUEST"

      - name: Generate Code Suggestions
        id: suggestions
        env:
          REQUEST: ${{ steps.extract-request.outputs.request }}
          PR_NUMBER: ${{ github.event.issue.number }}
        run: |
          echo "ğŸ’¡ ç”Ÿæˆä»£ç å»ºè®®..."
          
          # æ¨¡æ‹ŸCopilotå»ºè®®ç”Ÿæˆ
          SUGGESTION_RESPONSE="ğŸ¤– **GitHub Copilot å»ºè®®**

          é’ˆå¯¹æ‚¨çš„è¯·æ±‚: \`$REQUEST\`

          **å»ºè®®æ–¹æ¡ˆ:**"
          
          # æ ¹æ®ä¸åŒè¯·æ±‚ç±»å‹ç”Ÿæˆå»ºè®®
          case "$REQUEST" in
            *"test"*|*"æµ‹è¯•"*)
              SUGGESTION_RESPONSE="$SUGGESTION_RESPONSE
          
          1. **å•å…ƒæµ‹è¯•å»ºè®®:**
          \`\`\`go
          func TestYourFunction(t *testing.T) {
              tests := []struct {
                  name     string
                  input    interface{}
                  expected interface{}
              }{
                  {\"valid case\", validInput, expectedOutput},
                  {\"edge case\", edgeInput, edgeOutput},
              }
              
              for _, tt := range tests {
                  t.Run(tt.name, func(t *testing.T) {
                      result := YourFunction(tt.input)
                      assert.Equal(t, tt.expected, result)
                  })
              }
          }
          \`\`\`"
              ;;
            *"error"*|*"é”™è¯¯"*)
              SUGGESTION_RESPONSE="$SUGGESTION_RESPONSE
          
          1. **é”™è¯¯å¤„ç†å»ºè®®:**
          \`\`\`go
          if err != nil {
              log.Printf(\"operation failed: %v\", err)
              return fmt.Errorf(\"failed to perform operation: %w\", err)
          }
          \`\`\`"
              ;;
            *"optimize"*|*"ä¼˜åŒ–"*)
              SUGGESTION_RESPONSE="$SUGGESTION_RESPONSE
          
          1. **æ€§èƒ½ä¼˜åŒ–å»ºè®®:**
          - ä½¿ç”¨ \`sync.Pool\` å‡å°‘å†…å­˜åˆ†é…
          - è€ƒè™‘ä½¿ç”¨ç¼“å­˜æœºåˆ¶
          - æ‰¹é‡å¤„ç†æ•°æ®æ“ä½œ"
              ;;
            *)
              SUGGESTION_RESPONSE="$SUGGESTION_RESPONSE
          
          å¾ˆæŠ±æ­‰ï¼Œæˆ‘éœ€è¦æ›´å…·ä½“çš„è¯·æ±‚ä¿¡æ¯ã€‚è¯·å°è¯•ï¼š
          - \`@copilot suggest test\` - æµ‹è¯•ä»£ç å»ºè®®
          - \`@copilot suggest error handling\` - é”™è¯¯å¤„ç†å»ºè®®
          - \`@copilot suggest optimize\` - æ€§èƒ½ä¼˜åŒ–å»ºè®®"
              ;;
          esac
          
          SUGGESTION_RESPONSE="$SUGGESTION_RESPONSE

          **ä½¿ç”¨å»ºè®®:**
          - è¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ä»£ç 
          - ç¡®ä¿æ·»åŠ é€‚å½“çš„æµ‹è¯•
          - éµå¾ªé¡¹ç›®ä»£ç è§„èŒƒ
          
          å¦‚éœ€æ›´å¤šå¸®åŠ©ï¼Œè¯·ä½¿ç”¨ \`@copilot suggest <å…·ä½“éœ€æ±‚>\`"
          
          echo "suggestions<<EOF" >> $GITHUB_OUTPUT
          echo "$SUGGESTION_RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Reply with Suggestions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.issue.number }}
          SUGGESTIONS: ${{ steps.suggestions.outputs.suggestions }}
        run: |
          echo "ğŸ“¨ å›å¤å»ºè®®è¯„è®º..."
          gh pr comment $PR_NUMBER --body "$SUGGESTIONS"